@model IconicFund.Web.Models.PermissionsGroupsViewModel
@{
    var sessionService = ViewBag.sessionService;
}
<link href="~/css/datepicker/query.calendars.picker.css" rel="stylesheet" />

<div class="kt-portlet kt-portlet--mobile">
    <div class="kt-portlet__head kt-portlet__head--lg">
        <div class="kt-portlet__head-label">
            <span class="kt-portlet__head-icon"><i class="kt-font-brand flaticon2-lock"></i></span>
            <h3 class="kt-portlet__head-title">@Labels.PermissionGroups</h3>
        </div>
        <div class="kt-portlet__head-toolbar">
            <div class="kt-portlet__head-wrapper">
                <div class="kt-portlet__head-actions">
                    <a href="@Url.Content("~/PermissionsGroup/Create")" class="btn btn-success btn-icon-sm">
                        @Labels.Create
                        <img src="~/Images/add.svg" alt="Create" class="img-fluid" />
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="kt-portlet__body">
                                <div class="form-row col-sm-12" style=" background-color: #f5f5f5">

                            <div class="col-sm-3">
                                @Html.TextBoxFor(model => model.Name, new { @class = "form-control form-control-sm form-filter kt-input", placeholder = Messages.SearchByArchiveTitle })
                            </div>
                            <div class="col-sm-3">
                                <input type="text" asp-for="@Model.StartDate" class=" form-control txtHijriDate" asp-format="{0:dd-MMMM-yyyy}">
                            </div>
                            <div class="col-sm-3">
                                <input type="text" asp-for="@Model.EndDate" class=" form-control txtHijriDate" asp-format="{0:dd-MMMM-yyyy}">
                            </div>
                                <div class="col-sm-3">
                                    <button class="btn btn-success  btn-sm kt-btn--icon" style="margin-bottom:5px;" onclick="search()">
                                        <span>@Labels.Search</span>
                                    </button>
                                    <button class="btn-reset btn-sm kt-btn--icon" style="margin-bottom:5px;" onclick="resetSearchElements()">
                                        <span>@Labels.Reset</span>
                                    </button>
                                
                        </div>
</div>
        <div id="divList">
            <!-- begin: Datatable -->
            <div class="table100 ver1 ">
                <table class="table table-striped table-bordered table-hover table-checkable">
                    <thead>
                        <tr class="bg-dark" style="color:white;">

                            <th>@Labels.Description</th>
                            <th>@Labels.StartDate</th>
                            <th>@Labels.EndDate</th>
                            <th>@Labels.GroupAdmins</th>
                            <th>@Labels.Permissions</th>
                            <th>@Labels.Actions</th>


                        </tr>
                    </thead>
                    <tbody>

                        @if (Model.PermissionsGroupsList?.Count > 0)
                        {
                            foreach (var item in Model.PermissionsGroupsList)
                            {
                                <tr>

                                    <td>
                                        @item.Name
                                    </td>
                                    <td>
                                        @item.StartDate.Value.ToString("dd MMMM yyyy")
                                    </td>
                                    <td>
                                        @item.EndDate.Value.ToString("dd MMMM yyyy")
                                    </td>
                                    <td>
                                        <div id="placeholder_data"></div>
                                        <button  type="button" class="btn btn-success showAdminsGroup" data-target="#addAdminsModal" data-url="@Url.Action("PermissionGroupAdmins","PermissionsGroup",new { id = item.Code })">
                                            <i class="la la-plus"></i>
                                        </button>

                                    </td>

                                    <td>
                                        <button type="button" data-target="#PermissionModal"
                                                data-url="@Url.Action("PermissionsList","PermissionsGroup",new { id = item.Code })" class="btn btn-success showPermissions">
                                            @Labels.Permissions
                                            <i class="la la-plus"></i>
                                        </button>
                                    </td>

                                    <td>
                                        <a href="@Url.Content($"~/PermissionsGroup/Edit/{item.Code}")" class="btn btn-sm btn-info btn-icon btn-icon-md">
                                            <i class="la la-edit"></i>
                                        </a>
                                        <a href="#" class="btn btn-sm btn-danger btn-icon btn-icon-md" data-toggle="modal" data-target="#kt_modal_3" onclick="setDeletedItemId('@item.Code')" data-bind="@item.Code">
                                            <i class="la la-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="7">@Messages.NoData</td></tr>
                        }
                    </tbody>
                </table>
            </div>
            <!--end: Datatable -->
            <!--begin: Pagination-->
            @if (Model.PermissionsGroupsList?.Count > 0)
            {
                <div class="kt-pagination  kt-pagination--brand">
                    <div data-target="#divList">
                        @{
                            @Html.PagedListPager(Model.PermissionsGroupsList, page => Url.Action("Index", "PermissionsGroup", new
                            {
                               page = page,
                               Name = Model.Name,
                               StartDate = Model.StartDate,
                               EndDate = Model.EndDate
                            }))
                        }

                    </div>
                </div>
            }
            <!--end: Pagination-->
        </div>
    </div>

    <!--begin::Modal-->
    <div class="modal fade" id="kt_modal_3" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">@Labels.Delete @Labels.Admin</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    </button>
                </div>
                <div class="modal-body">
                    <h5 class="kt-font-danger">@Labels.Warning</h5>
                    <p>@Messages.DeleteConfirmation</p>
                </div>
                <div class="modal-footer">
                    <a id="lnkModelDelete" class="btn btn-brand">@Labels.Yes</a>
                    <button type="button" class="btn btn-cancel" data-dismiss="modal">@Labels.Cancel</button>

                </div>
            </div>
        </div>
    </div>
    <!--end::Modal-->
    <!--begin::Modal-->
    <div class="modal" id="PermissionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">@Labels.Create @Labels.Permissions</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="PermissionContainer">

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-brand" onclick="PermissionOnChecked()">@Labels.Save</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">@Labels.Cancel</button>

                </div>
            </div>
        </div>

    </div>
    <!--end::Modal-->


</div>
@section Scripts {
    <script type="text/javascript">

    $('document').ready(function () {

        $(function () {
            debugger
            var placeholderElement = $('#placeholder_data');
            $('.showAdminsGroup').click(function (event) {
                debugger
                var url = $(this).data('url');
                $.get(url).done(function (data) {
                    debugger
                    placeholderElement.html(data);
                    placeholderElement.find('.modal').modal('show');
                })

            })

        })


        $('.showPermissions').click(function () {
            debugger
            var url = $(this).data('url');

            $.get(url, function (data) {
                debugger
                $('#PermissionContainer').html(data);

                $('#PermissionModal').modal('show');
            });
        });
    });
//-----------------------------------------
     function CheckBoxChanged(Id){

      debugger
     var isChecked = true;
     var checkBoxValue = $('#checkbox_' + Id).is(':checked');
     if (checkBoxValue == false) {
      isChecked = false;
      }

     $.ajax({

     type: "Post",
     url: '@Url.Action("CreatePermissionGroupAdmins", "PermissionsGroup")',
     data: {
         AdminId : Id,
         CheckedValue: isChecked,

         },
     dataType: "html",
     success: function (response) {
        debugger

     },
     error: function (error) {
     }
     })
    }
//------------------------------------
     function PermissionOnChecked(){

     debugger
         var selected = [];
         $('#checkboxes input:checked').each(function () {
             selected.push($(this).attr('name'));
         });

     $.ajax({

     type: "Post",
     url: '@Url.Action("CreatePermissionList", "PermissionsGroup")',
     data: {
         Permissions: selected,
         },
     dataType: "html",
         success: function () {
             $('#PermissionModal').modal('hide');
     },
     error: function () {
     }
     })
    }
//--------------------------------------
     function ReloadPage()
    {
      window.location.reload(true);
    }
//------------------------------------
     function setDeletedItemId(itemId) {
        $('#lnkModelDelete').attr('href', '/PermissionsGroup/Delete/' + itemId);
    }
//------------------------------------
    function resetSearchElements() 
    {
        var pageSize = $('#PageSize').val();
        $('#divList').load('@Url.Content("~/PermissionsGroup/Index")?pageSize=' + pageSize + ' #divList');
    }
//------------------------------------
    function search() {
        debugger
        //Get the values of the filteration controls

        var Name = ($('#Name').val() == undefined ? "" : $('#Name').val());
        var StartDate = ($('#StartDate').val() == undefined ? "" : $('#StartDate').val());        
        var EndDate = ($('#EndDate').val() == undefined ? "" : $('#EndDate').val());

        console.log(StartDate);
        console.log(EndDate);

        @*var url = encodeURI('@Url.Content("~/PermissionsGroup/Index")?Code=' + Code + '&Name=' + Name + '&StartDate=' + StartDate + '&EndDate=' + EndDate);*@
        var url = encodeURI('@Url.Content("~/PermissionsGroup/Index")?Name=' + Name + '&StartDate=' + StartDate + '&EndDate=' + EndDate);

        $('#divList').load(url + ' #divList');
    }

    </script>
}